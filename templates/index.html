{% extends "base.html" %} {% block title %}Eventify | Events{% endblock %} {%
block content %}

<div
  class="flex flex-col md:flex-row md:items-center md:justify-between gap-4 mb-8"
>
  <div>
    <h1 class="text-3xl font-bold text-gray-900">Upcoming Events</h1>
    <p class="text-gray-600 mt-1">Search and register for college events.</p>
  </div>

  <!-- Search + Filter -->
  <form
    id="searchForm"
    method="GET"
    class="flex flex-col md:flex-row gap-2 w-full md:w-auto"
  >
    <input
      id="searchInput"
      type="text"
      name="q"
      value="{{ q }}"
      placeholder="Search events..."
      class="w-full md:w-72 px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500"
    />

    <select
      id="filterSelect"
      name="filter"
      class="w-full md:w-48 px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500"
    >
      <option
        value="upcoming"
        {%
        if
        filter_option=""
        ="upcoming"
        %}selected{%
        endif
        %}
      >
        Upcoming Only
      </option>
      <option value="all" {% if filter_option="" ="all" %}selected{% endif %}>
        All Events
      </option>
    </select>
  </form>
</div>

<!-- Events Grid -->
<div
  id="eventsGrid"
  class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"
>
  {% for event in events %}
  <div
    class="bg-white rounded-2xl shadow-sm border p-5 hover:shadow-md transition"
  >
    <h2 class="text-xl font-semibold text-gray-900">{{ event.title }}</h2>

    <p class="text-gray-600 mt-2 line-clamp-3">{{ event.description }}</p>

    <div class="mt-4 space-y-2 text-sm text-gray-700">
      <p><span class="font-medium">ğŸ“… Date:</span> {{ event.event_date }}</p>
      <p><span class="font-medium">â° Time:</span> {{ event.event_time }}</p>
      <p><span class="font-medium">ğŸ“ Venue:</span> {{ event.venue }}</p>
    </div>

    <div class="mt-5 flex items-center justify-between">
      <div class="flex flex-col gap-2">
        <span
          class="px-3 py-1 rounded-full text-xs font-semibold bg-indigo-100 text-indigo-700 w-fit"
        >
          Registered: {{ event.registered_count }} / {{ event.capacity }}
        </span>

        {% if event.seats_left > 0 %}
        <span
          class="px-3 py-1 rounded-full text-xs font-semibold bg-green-100 text-green-700 w-fit"
        >
          Seats Left: {{ event.seats_left }}
        </span>
        {% else %}
        <span
          class="px-3 py-1 rounded-full text-xs font-semibold bg-red-100 text-red-700 w-fit"
        >
          Event Full
        </span>
        {% endif %}
      </div>

      <a
        href="/event/{{ event.id }}"
        class="text-indigo-600 font-semibold hover:underline"
      >
        View â†’
      </a>
    </div>
  </div>
  {% endfor %}
</div>

{% if events|length == 0 %}
<div class="bg-white border rounded-xl p-6 text-center text-gray-600">
  No events found.
</div>
{% endif %}

<!-- LIVE SEARCH SCRIPT -->
<script>
  let typingTimer;

  const searchInput = document.getElementById("searchInput");
  const filterSelect = document.getElementById("filterSelect");
  const eventsGrid = document.getElementById("eventsGrid");

  function renderEvents(events) {
    if (!events || events.length === 0) {
      eventsGrid.innerHTML = `
        <div class="bg-white border rounded-xl p-6 text-center text-gray-600 col-span-full">
          No events found.
        </div>
      `;
      return;
    }

    let html = "";

    events.forEach((event) => {
      const isFull = event.seats_left <= 0;

      html += `
        <div class="bg-white rounded-2xl shadow-sm border p-5 hover:shadow-md transition">
          <h2 class="text-xl font-semibold text-gray-900">${event.title}</h2>

          <p class="text-gray-600 mt-2 line-clamp-3">
            ${event.description}
          </p>

          <div class="mt-4 space-y-2 text-sm text-gray-700">
            <p><span class="font-medium">ğŸ“… Date:</span> ${event.event_date}</p>
            <p><span class="font-medium">â° Time:</span> ${event.event_time}</p>
            <p><span class="font-medium">ğŸ“ Venue:</span> ${event.venue}</p>
          </div>

          <div class="mt-5 flex items-center justify-between">
            <div class="flex flex-col gap-2">
              <span class="px-3 py-1 rounded-full text-xs font-semibold bg-indigo-100 text-indigo-700 w-fit">
                Registered: ${event.registered_count} / ${event.capacity}
              </span>

              ${
                !isFull
                  ? `<span class="px-3 py-1 rounded-full text-xs font-semibold bg-green-100 text-green-700 w-fit">
                    Seats Left: ${event.seats_left}
                   </span>`
                  : `<span class="px-3 py-1 rounded-full text-xs font-semibold bg-red-100 text-red-700 w-fit">
                    Event Full
                   </span>`
              }
            </div>

            <a href="/event/${event.id}"
               class="text-indigo-600 font-semibold hover:underline">
              View â†’
            </a>
          </div>
        </div>
      `;
    });

    eventsGrid.innerHTML = html;
  }

  async function fetchEvents() {
    const q = searchInput.value.trim();
    const filter = filterSelect.value;

    const res = await fetch(
      `/api/events?q=${encodeURIComponent(q)}&filter=${encodeURIComponent(filter)}`,
    );
    const data = await res.json();

    renderEvents(data);
  }

  function autoSearch() {
    clearTimeout(typingTimer);

    typingTimer = setTimeout(() => {
      fetchEvents();
    }, 300);
  }

  searchInput.addEventListener("input", autoSearch);
  filterSelect.addEventListener("change", fetchEvents);
</script>

{% endblock %}
